<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í˜¸ì¹˜ë¯¼ ìŒ¤ - ì‹¤ì „ íšŒí™”</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #F3F4F6;
        }
        .font-cute {
            font-family: 'Quicksand', 'Noto Sans KR', sans-serif;
        }
        
        /* Chat Bubble Animation */
        @keyframes floatIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bubble {
            animation: floatIn 0.3s ease-out forwards;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }

        /* Prose Customization */
        .prose p { margin-bottom: 0.2em; }
        .prose strong { color: #0D9488; font-weight: 700; }
        
        /* Pulse Animation for Mic */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .mic-active {
            animation: pulse-red 1.5s infinite;
            background-color: #FECACA !important;
            color: #DC2626 !important;
            border-color: #DC2626 !important;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 bg-gray-50">

    <!-- Header -->
    <header class="bg-white p-4 shadow-sm flex justify-between items-center z-20 border-b border-gray-100">
        <div class="flex items-center gap-2">
            <span class="text-2xl">ğŸ‡»ğŸ‡³</span>
            <div>
                <h1 class="text-lg font-bold font-cute text-teal-600 leading-tight">í˜¸ì¹˜ë¯¼ ìŒ¤</h1>
                <p class="text-xs text-gray-500">ì‹¤ì „ íšŒí™” íŒŒíŠ¸ë„ˆ</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <!-- Auto TTS Toggle -->
            <button id="autoTtsBtn" onclick="toggleAutoTts()" class="flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 text-xs text-gray-500 transition hover:bg-teal-50">
                <span>ğŸ”ˆ ìë™ë“£ê¸° Off</span>
            </button>
            <button id="settingsBtn" class="text-gray-400 hover:text-teal-500 transition">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Scenario Chips -->
    <div class="bg-white px-4 py-3 border-b border-gray-100 flex gap-2 overflow-x-auto no-scrollbar">
        <button onclick="startScenario('cafe')" class="whitespace-nowrap px-4 py-2 bg-orange-50 text-orange-600 rounded-full text-sm font-bold border border-orange-100 hover:bg-orange-100 transition">
            â˜• ì¹´í˜ ì£¼ë¬¸
        </button>
        <button onclick="startScenario('taxi')" class="whitespace-nowrap px-4 py-2 bg-blue-50 text-blue-600 rounded-full text-sm font-bold border border-blue-100 hover:bg-blue-100 transition">
            ğŸš• íƒì‹œ íƒ€ê¸°
        </button>
        <button onclick="startScenario('market')" class="whitespace-nowrap px-4 py-2 bg-green-50 text-green-600 rounded-full text-sm font-bold border border-green-100 hover:bg-green-100 transition">
            ğŸ’° ì‹œì¥ í¥ì •
        </button>
        <button onclick="startScenario('greeting')" class="whitespace-nowrap px-4 py-2 bg-purple-50 text-purple-600 rounded-full text-sm font-bold border border-purple-100 hover:bg-purple-100 transition">
            ğŸ‘‹ ì²˜ìŒ ë§Œë‚¨
        </button>
    </div>

    <!-- Chat Area -->
    <main id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
        <!-- Initial Bot Message -->
        <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-full bg-teal-100 flex items-center justify-center text-xl shadow-sm flex-shrink-0 border-2 border-white">ğŸ‘©â€ğŸ«</div>
            <div class="bubble bg-white text-gray-800 rounded-2xl rounded-tl-none px-4 py-3 max-w-[85%] border border-gray-100">
                <p class="text-sm">Xin chÃ o! (ì”¬ ì§œì˜¤!) ğŸ‘‹<br>
                ì €ëŠ” í˜¸ì¹˜ë¯¼ì—ì„œ ì˜¨ ê³¼ì™¸ ì„ ìƒë‹˜ì´ì—ìš”.<br>
                <strong>ìœ„ì˜ ë²„íŠ¼</strong>ì„ ëˆŒëŸ¬ì„œ ìƒí™©ê·¹ì„ ì‹œì‘í•˜ê±°ë‚˜, ë§ˆì´í¬ë¥¼ ì¼œê³  ì €ë‘ ìˆ˜ë‹¤ ë–¨ì–´ìš”!</p>
            </div>
        </div>
    </main>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="hidden px-4 py-2">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">â³</div>
            <span class="text-xs text-gray-400 animate-pulse">ë‹µë³€ ìƒì„± ì¤‘...</span>
        </div>
    </div>

    <!-- Input Area -->
    <footer class="bg-white border-t border-gray-200 p-3 pb-safe">
        <!-- Mic Controls -->
        <div class="flex justify-center gap-4 mb-3">
            <button id="micKoBtn" onclick="toggleMic('ko-KR')" class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-bold transition border border-transparent">
                ğŸ¤ í•œêµ­ì–´ë¡œ ì§ˆë¬¸
            </button>
            <button id="micViBtn" onclick="toggleMic('vi-VN')" class="flex items-center gap-2 px-4 py-2 rounded-full bg-teal-50 hover:bg-teal-100 text-teal-700 text-sm font-bold transition border border-teal-100">
                ğŸ‡»ğŸ‡³ ë² íŠ¸ë‚¨ì–´ë¡œ ì—°ìŠµ
            </button>
        </div>

        <!-- Text Input -->
        <div class="max-w-4xl mx-auto relative flex items-end gap-2">
            <div class="relative flex-1">
                <textarea id="userInput" rows="1"
                    class="w-full bg-gray-100 text-gray-800 rounded-2xl pl-4 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:bg-white transition resize-none text-sm"
                    placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="handleEnter(event)"></textarea>
            </div>
            <button onclick="sendMessage()" 
                class="bg-teal-500 hover:bg-teal-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg transition transform active:scale-95 flex-shrink-0 mb-0.5">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                </svg>
            </button>
        </div>
    </footer>

    <!-- Settings Modal -->
    <div id="apiModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h2 class="text-lg font-bold mb-4 text-gray-800">ì„¤ì •</h2>
            <label class="block text-xs text-gray-500 mb-1">Google Gemini API Key</label>
            <input type="password" id="apiKeyInput" class="w-full border border-gray-200 rounded-lg p-3 mb-4 text-sm focus:outline-none focus:border-teal-500 bg-gray-50" placeholder="sk-...">
            <button onclick="saveApiKey()" class="w-full py-3 bg-teal-500 hover:bg-teal-600 text-white rounded-xl font-bold shadow-md transition">ì €ì¥í•˜ê¸°</button>
            <button onclick="closeModal()" class="w-full mt-2 py-2 text-gray-400 text-sm">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // ============================================================================
        // [ì„¤ì •] API KEY & MODEL
        // ============================================================================
        const HARDCODED_API_KEY = "AIzaSyDj4q62kq0vH0UGbtAl_gpyO1reHngv4I8"; 
        const MODEL_NAME = "gemini-2.5-flash";
        // ============================================================================

        // --- SYSTEM PROMPT (íšŒí™”/ë¡¤í”Œë ˆì‰ ì¤‘ì‹¬) ---
        const SYSTEM_INSTRUCTION = `
        ë‹¹ì‹ ì€ í˜¸ì¹˜ë¯¼(ë‚¨ë¶€) ì¶œì‹ ì˜ ë² íŠ¸ë‚¨ì–´ ê³¼ì™¸ ì„ ìƒë‹˜ì´ì 'ëŒ€í™” íŒŒíŠ¸ë„ˆ'ì…ë‹ˆë‹¤.
        
        [í•µì‹¬ ì—­í• ]
        1. **ì‹¤ì „ íšŒí™” ë¦¬ë“œ**: ë¬¸ë²• ì„¤ëª…ë³´ë‹¤ëŠ” **ì‹¤ì œ ëŒ€í™”(Role-Play)**ë¥¼ ê³„ì† ì´ì–´ë‚˜ê°€ì„¸ìš”.
        2. **ë°œìŒ êµì •**: í•™ìƒì´ ë² íŠ¸ë‚¨ì–´ë¥¼ ì‹œë„í•˜ë©´ ì¹­ì°¬í•˜ê³ , ë” ìì—°ìŠ¤ëŸ¬ìš´ ë‚¨ë¶€ ë°œìŒì„ ì•Œë ¤ì£¼ì„¸ìš”.
        3. **ë‚¨ë¶€ ë°©ì–¸ í•„ìˆ˜**: ëª¨ë“  ì–´íœ˜ì™€ ë°œìŒì€ **í˜¸ì¹˜ë¯¼(ë‚¨ë¶€)** ê¸°ì¤€ì…ë‹ˆë‹¤. (ì˜ˆ: Muá»—ng, ChÃ©n, BÃ´ng...)
        
        [ì¶œë ¥ ê·œì¹™]
        - ëª¨ë“  ë² íŠ¸ë‚¨ì–´ ë¬¸ì¥ ì•„ë˜ì— **ë°˜ë“œì‹œ [í•œê¸€ ë°œìŒ]**ì„ ì ìœ¼ì„¸ìš”.
        - í•™ìƒì´ í•œêµ­ì–´ë¡œ ë§í•˜ë©´ -> ì ì ˆí•œ ë² íŠ¸ë‚¨ì–´ í‘œí˜„ì„ ì•Œë ¤ì£¼ê³  "í•œë²ˆ ë§í•´ë³´ì„¸ìš”!"ë¼ê³  ê¶Œìœ í•˜ì„¸ìš”.
        - í•™ìƒì´ ìƒí™©ê·¹ì„ ìš”ì²­í•˜ë©´ -> ì¦‰ì‹œ ê·¸ ìƒí™©ì˜ ìƒëŒ€ì—­(ì¢…ì—…ì›, ê¸°ì‚¬ ë“±)ì´ ë˜ì–´ ì—°ê¸°ë¥¼ ì‹œì‘í•˜ì„¸ìš”.
        - ë‹µë³€ì€ **ëŒ€í™”ì²´**ë¡œ ì§§ê³  ê°„ê²°í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”. (ê¸¸ë©´ ì§€ë£¨í•´í•©ë‹ˆë‹¤.)
        
        [ì˜ˆì‹œ]
        í•™ìƒ: ì»¤í”¼ ì£¼ë¬¸í•˜ê³  ì‹¶ì–´.
        ì„ ìƒë‹˜: ì¢‹ì•„ìš”! ì œê°€ ì¹´í˜ ì§ì›ì´ì—ìš”. ì£¼ë¬¸ ë°›ì•„ë³¼ê²Œìš”.
        **"QuÃ½ khÃ¡ch dÃ¹ng chi?"**
        [ìœ„ ì¹´ìµ ìœµ ì°Œ?]
        (ì†ë‹˜, ë­ ë“œì‹œê² ì–´ìš”?)
        `;

        let chatHistory = [
            { role: "user", parts: [{ text: SYSTEM_INSTRUCTION }] },
            { role: "model", parts: [{ text: "ë„¤! í˜¸ì¹˜ë¯¼ ìŠ¤íƒ€ì¼ ì‹¤ì „ íšŒí™”, ì§€ê¸ˆ ë°”ë¡œ ì‹œì‘í•´ìš”!" }] }
        ];

        // --- STATE ---
        let isAutoTts = false;
        let recognition = null;
        let isRecording = false;

        // --- DOM ---
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const autoTtsBtn = document.getElementById('autoTtsBtn');
        
        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => {
            if (!HARDCODED_API_KEY && !localStorage.getItem('gemini_api_key')) {
                document.getElementById('apiModal').classList.remove('hidden');
            }
            setupSpeechRecognition();
        });

        document.getElementById('settingsBtn').addEventListener('click', () => {
            const key = HARDCODED_API_KEY || localStorage.getItem('gemini_api_key');
            if(key) document.getElementById('apiKeyInput').value = key;
            document.getElementById('apiModal').classList.remove('hidden');
        });

        function closeModal() { document.getElementById('apiModal').classList.add('hidden'); }
        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key) {
                localStorage.setItem('gemini_api_key', key);
                closeModal();
            }
        }

        // --- SPEECH RECOGNITION (STT) ---
        function setupSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í¬ë¡¬ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                return;
            }
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = function() {
                isRecording = true;
            };
            
            recognition.onend = function() {
                isRecording = false;
                resetMicButtons();
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                sendMessage(); // ì¸ì‹ë˜ìë§ˆì ë°”ë¡œ ì „ì†¡
            };

            recognition.onerror = function(event) {
                console.error("Speech Error:", event.error);
                isRecording = false;
                resetMicButtons();
            };
        }

        function toggleMic(lang) {
            if (!recognition) return;

            if (isRecording) {
                recognition.stop();
                return;
            }

            // UI Update
            resetMicButtons();
            const btnId = lang === 'ko-KR' ? 'micKoBtn' : 'micViBtn';
            document.getElementById(btnId).classList.add('mic-active');

            recognition.lang = lang;
            recognition.start();
        }

        function resetMicButtons() {
            document.getElementById('micKoBtn').classList.remove('mic-active');
            document.getElementById('micViBtn').classList.remove('mic-active');
        }


        // --- TEXT TO SPEECH (TTS) ---
        function toggleAutoTts() {
            isAutoTts = !isAutoTts;
            autoTtsBtn.innerHTML = isAutoTts 
                ? `<span class="text-teal-600 font-bold">ğŸ”Š ìë™ë“£ê¸° On</span>` 
                : `<span>ğŸ”ˆ ìë™ë“£ê¸° Off</span>`;
            autoTtsBtn.className = isAutoTts
                ? "flex items-center gap-1 px-2 py-1 rounded-full bg-teal-100 text-xs text-teal-700 transition"
                : "flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 text-xs text-gray-500 transition hover:bg-teal-50";
        }

        function speak(text) {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();

            // Clean text: Markdown ì œê±°, ê´„í˜¸ ì•ˆ í•œê¸€ ë°œìŒ ì œê±°(ë² íŠ¸ë‚¨ì–´ë§Œ ì½ê¸° ìœ„í•´)
            // ì˜ˆ: "Xin chÃ o [ì”¬ ì§œì˜¤]" -> "Xin chÃ o"
            let cleanText = text.replace(/\[.*?\]/g, '').replace(/\(.*?\)/g, '').replace(/[*_`]/g, '');
            
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'vi-VN';
            utterance.rate = 0.85; // ì´ˆë³´ìë¥¼ ìœ„í•´ ì²œì²œíˆ

            // ë‚¨ë¶€ ì–µì–‘ ë³´ì¥ì€ ì–´ë µì§€ë§Œ, ë² íŠ¸ë‚¨ì–´ ë³´ì´ìŠ¤ ìš°ì„  ì„ íƒ
            const voices = window.speechSynthesis.getVoices();
            const vnVoice = voices.find(v => v.lang.includes('vi'));
            if (vnVoice) utterance.voice = vnVoice;

            window.speechSynthesis.speak(utterance);
        }

        // --- CHAT LOGIC ---
        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function startScenario(type) {
            const scenarios = {
                'cafe': "ì§€ê¸ˆë¶€í„° ì¹´í˜ ìƒí™©ê·¹ì„ ì‹œì‘í•˜ì. ë„¤ê°€ ì¹´í˜ ì§ì› í•´ì¤˜. ë‚˜ëŠ” ì†ë‹˜ í• ê²Œ.",
                'taxi': "íƒì‹œë¥¼ íƒ”ì–´. ë„¤ê°€ íƒì‹œ ê¸°ì‚¬ê³ , ë‚˜ëŠ” 1êµ° ë²¤íƒ„ ì‹œì¥ìœ¼ë¡œ ê°€ê³  ì‹¶ì€ ì†ë‹˜ì´ì•¼. ìƒí™©ê·¹ ì‹œì‘í•´.",
                'market': "ì‹œì¥ì—ì„œ ë¬¼ê±´ì„ ì‚¬ê³  ì‹¶ì–´. ë„¤ê°€ ê°€ê²Œ ì£¼ì¸ì´ê³  ë‚´ê°€ í¥ì •í•˜ëŠ” ì†ë‹˜ì´ì•¼. ë¹„ì‹¸ë‹¤ê³  ê¹ì•„ë‹¬ë¼ê³  í• ê²Œ.",
                'greeting': "ì²˜ìŒ ë§Œë‚œ ë² íŠ¸ë‚¨ ì¹œêµ¬ì—ê²Œ ì¸ì‚¬í•˜ê³  ì‹¶ì–´. ë„¤ê°€ ê·¸ ì¹œêµ¬ê°€ ë˜ì–´ì¤˜."
            };
            userInput.value = scenarios[type];
            sendMessage();
        }

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `flex items-start gap-3 ${role === 'user' ? 'justify-end' : ''}`;

            const avatar = role === 'model' 
                ? `<div class="w-10 h-10 rounded-full bg-teal-100 flex items-center justify-center text-xl shadow-sm flex-shrink-0 border-2 border-white">ğŸ‘©â€ğŸ«</div>` 
                : '';
            
            const bubbleClass = role === 'user' 
                ? 'bg-teal-500 text-white rounded-tr-none' 
                : 'bg-white text-gray-800 rounded-tl-none border border-gray-100';

            // ìˆ˜ë™ TTS ë²„íŠ¼ (AI ë©”ì‹œì§€ì—ë§Œ)
            const ttsButton = role === 'model'
                ? `<button onclick="speak(this.parentElement.innerText)" class="absolute -right-6 top-1 text-gray-300 hover:text-teal-500 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                      <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" />
                      <path d="M15.932 7.757a.75.75 0 011.061 0 6 6 0 010 8.486.75.75 0 01-1.06-1.061 4.5 4.5 0 000-6.364.75.75 0 010-1.06z" />
                    </svg>
                   </button>`
                : '';

            const parsedContent = marked.parse(text);

            div.innerHTML = `
                ${role === 'model' ? avatar : ''}
                <div class="bubble ${bubbleClass} px-4 py-3 max-w-[85%] rounded-2xl relative text-sm leading-relaxed prose prose-sm">
                    ${parsedContent}
                </div>
                ${ttsButton}
            `;

            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            const apiKey = HARDCODED_API_KEY || localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                document.getElementById('apiModal').classList.remove('hidden');
                return;
            }

            userInput.value = '';
            // í…ìŠ¤íŠ¸ë°•ìŠ¤ ë†’ì´ ì´ˆê¸°í™”
            userInput.style.height = 'auto';
            
            appendMessage('user', text);
            loadingIndicator.classList.remove('hidden');
            chatContainer.scrollTop = chatContainer.scrollHeight;

            chatHistory.push({ role: "user", parts: [{ text: text }] });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: chatHistory,
                        generationConfig: {
                            temperature: 0.8, // ì°½ì˜ì ì¸ ëŒ€í™”ë¥¼ ìœ„í•´ ë†’ì„
                            maxOutputTokens: 500,
                        }
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    if(data.error.code === 404 && MODEL_NAME.includes('2.5')) {
                         throw new Error(`ëª¨ë¸(${MODEL_NAME}) ì˜¤ë¥˜.<br>gemini-1.5-flashë¡œ ë³€ê²½í•´ë³´ì„¸ìš”.`);
                    }
                    throw new Error(data.error.message);
                }

                const botText = data.candidates[0].content.parts[0].text;
                
                loadingIndicator.classList.add('hidden');
                appendMessage('model', botText);
                
                chatHistory.push({ role: "model", parts: [{ text: botText }] });

                // Auto TTS
                if (isAutoTts) {
                    speak(botText);
                }

            } catch (error) {
                loadingIndicator.classList.add('hidden');
                appendMessage('model', `âš ï¸ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // Auto resize textarea
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    </script>
</body>
</html>
