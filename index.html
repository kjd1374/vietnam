<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í˜¸ì¹˜ë¯¼ 1:1 ê³¼ì™¸ - ì„ ìƒë‹˜ Linh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- ì´ëª¨ì§€ ë° ì•„ì´ì½˜ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° (ê¹”ë”í•œ UI) */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ë§í•˜ê¸° ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        .mic-active::before {
            content: '';
            position: absolute;
            left: 0; top: 0; width: 100%; height: 100%;
            border-radius: 50%;
            background-color: rgba(239, 68, 68, 0.5);
            z-index: -1;
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        /* íƒ€ì´í•‘/ë§í•˜ëŠ” ì¤‘ ì• ë‹ˆë©”ì´ì…˜ */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden relative">

    <!-- 1. í—¤ë” (ì„¤ì • ë° ìƒíƒœ) -->
    <header class="flex-none h-16 bg-white shadow-sm flex items-center justify-between px-4 z-10">
        <div class="flex items-center gap-3">
            <div class="relative">
                <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-2xl border-2 border-yellow-400 overflow-hidden">
                    ğŸ‘©â€ğŸ«
                </div>
                <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
            </div>
            <div>
                <h1 class="font-bold text-gray-800 text-sm">Linh ì„ ìƒë‹˜ (í˜¸ì¹˜ë¯¼)</h1>
                <div class="flex items-center gap-2">
                    <p class="text-xs text-green-600 flex items-center gap-1">
                        <i class="fas fa-wifi text-[10px]"></i> ì—°ê²°ë¨
                    </p>
                    <button onclick="testVoice()" class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-medium active:scale-95 transition-transform">
                        ğŸ”Š ì†Œë¦¬ í…ŒìŠ¤íŠ¸
                    </button>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <!-- TTS í† ê¸€ -->
            <button id="ttsToggleBtn" class="text-gray-400 hover:text-blue-500 transition-colors" title="ìë™ ìŒì„± ë“£ê¸°">
                <i class="fas fa-volume-up text-lg"></i>
            </button>
            <!-- ì„¤ì • -->
            <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-cog text-lg"></i>
            </button>
        </div>
    </header>

    <!-- 2. ë©”ì¸ ì±„íŒ… ì˜ì—­ (í†µí™” ëŠë‚Œ) -->
    <main id="chatContainer" class="flex-1 overflow-y-auto p-4 bg-[#f2f4f7] no-scrollbar flex flex-col gap-4 pb-32">
        <!-- ì›°ì»´ ë©”ì‹œì§€ -->
        <div class="flex flex-col items-center justify-center mt-8 mb-4 opacity-60">
            <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center text-5xl shadow-sm mb-3">
                ğŸ‡»ğŸ‡³
            </div>
            <p class="text-sm text-gray-500 text-center">
                í˜¸ì¹˜ë¯¼ í† ë°•ì´ Linh ì„ ìƒë‹˜ê³¼<br>
                í¸í•˜ê²Œ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!
            </p>
            <p class="text-[10px] text-red-400 mt-4 bg-red-50 px-2 py-1 rounded border border-red-100">
                â€» ì•„ì´í° ì‚¬ìš©ìëŠ” <b>ì§„ë™(ë¬´ìŒ) ëª¨ë“œ</b>ë¥¼ í•´ì œí•´ì•¼<br>ì„ ìƒë‹˜ ëª©ì†Œë¦¬ê°€ ë“¤ë¦½ë‹ˆë‹¤! ğŸ”Š
            </p>
        </div>
        
        <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </main>

    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° (ìˆ¨ê¹€ ìƒíƒœ) -->
    <div id="loadingIndicator" class="hidden absolute bottom-36 left-4 bg-white px-4 py-2 rounded-full shadow-md z-20 flex items-center gap-2">
        <span class="text-xs text-gray-500 font-medium">ì„ ìƒë‹˜ì´ ë§í•˜ëŠ” ì¤‘...</span>
        <div class="flex gap-1">
            <div class="w-1.5 h-1.5 bg-blue-500 rounded-full typing-dot"></div>
            <div class="w-1.5 h-1.5 bg-blue-500 rounded-full typing-dot"></div>
            <div class="w-1.5 h-1.5 bg-blue-500 rounded-full typing-dot"></div>
        </div>
    </div>

    <!-- 3. ì»¨íŠ¸ë¡¤ íŒ¨ë„ (í•˜ë‹¨ ê³ ì •) -->
    <footer class="flex-none bg-white border-t border-gray-100 p-4 pb-6 z-20 rounded-t-3xl shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <div class="flex flex-col items-center gap-4 relative">
            
            <!-- í…ìŠ¤íŠ¸ ì…ë ¥ (ë³´ì¡°) -->
            <div class="w-full flex gap-2 opacity-100 transition-all duration-300" id="textInputArea">
                <input type="text" id="txtInput" 
                    class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200" 
                    placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="handleEnter(event)">
                <button onclick="sendMessage()" class="bg-blue-500 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-sm active:scale-95 transition-transform">
                    <i class="fas fa-paper-plane text-sm"></i>
                </button>
            </div>

            <!-- ì´ˆëŒ€í˜• ë§ˆì´í¬ ë²„íŠ¼ (í† ê¸€ ë°©ì‹) -->
            <div class="relative -mt-2 flex flex-col items-center">
                <button id="micBtn" 
                    class="w-20 h-20 rounded-full bg-gradient-to-b from-red-500 to-red-600 text-white shadow-lg flex items-center justify-center text-3xl transition-all active:scale-95 relative z-10 focus:outline-none hover:shadow-xl"
                    onclick="toggleListening()">
                    <i class="fas fa-microphone"></i>
                </button>
                <p id="micStatusText" class="text-xs text-gray-400 mt-2 font-medium transition-colors">í„°ì¹˜í•´ì„œ ë§í•˜ê¸° (Start)</p>
            </div>
        </div>
    </footer>

    <!-- 4. API Key ì„¤ì • ëª¨ë‹¬ -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-xl">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="fas fa-key text-yellow-500"></i> ì„¤ì •
            </h3>
            <div class="mb-4">
                <label class="block text-xs text-gray-500 mb-1">Gemini API Key</label>
                <input type="password" id="apiKeyInput" class="w-full border border-gray-300 rounded-lg p-2 text-sm" placeholder="API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="toggleSettings()" class="px-4 py-2 text-gray-500 text-sm">ë‹«ê¸°</button>
                <button onclick="saveApiKey()" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium">ì €ì¥</button>
            </div>
            <p class="text-[10px] text-gray-400 mt-4 text-center">
                API KeyëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.
            </p>
        </div>
    </div>

    <script>
        // ============================================================================
        // â–¼â–¼â–¼ [í•„ìˆ˜] ì—¬ê¸°ì— API í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” (ë”°ì˜´í‘œ "" ì‚¬ì´ì— ì…ë ¥) â–¼â–¼â–¼
        // ì˜ˆ: const HARDCODED_API_KEY = "AIzaSy...";
        const HARDCODED_API_KEY = "AIzaSyDTIX9fsvu1a8vrDvIeI_zBx5U5QhAayAQ"; 
        // ============================================================================
        
        // ëª¨ë¸ ì„¤ì •
        const MODEL_NAME = "gemini-2.5-flash";

        // ëª¨ë°”ì¼ TTS í˜¸í™˜ì„±ì„ ìœ„í•œ ì „ì—­ ë³€ìˆ˜
        let voices = [];
        let ttsUnlocked = false;

        /**
         * ìƒíƒœ ê´€ë¦¬
         */
        let recognition = null;
        let isListening = false;
        let isAutoRead = true;
        let chatHistory = [];
        const SYSTEM_INSTRUCTION = `
            Role: ë‹¹ì‹ ì€ í˜¸ì¹˜ë¯¼ ì¶œì‹ ì˜ 20ëŒ€ ë² íŠ¸ë‚¨ì–´ ê°œì¸ ê³¼ì™¸ ì„ ìƒë‹˜ 'Linh'ì…ë‹ˆë‹¤.
            
            Dialect Requirement (Strict):
            - ë¬´ì¡°ê±´ ë² íŠ¸ë‚¨ ë‚¨ë¶€(í˜¸ì¹˜ë¯¼) ì‚¬íˆ¬ë¦¬ì™€ ì–´íœ˜ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
            - ì˜ˆ: 'muá»—ng' (ìˆ˜ì €), 'chÃ©n' (ê·¸ë¦‡), 'bÃ´ng' (ê½ƒ), 'báº¯p' (ì˜¥ìˆ˜ìˆ˜), 'heo' (ë¼ì§€).
            - ë¶ë¶€ í‘œì¤€ì–´(Hanoi) ì–´íœ˜ëŠ” í”¼í•˜ì„¸ìš”.

            Teaching Style:
            1. ì ˆëŒ€ ê¸¸ê²Œ ê°•ì˜í•˜ì§€ ë§ˆì„¸ìš”. ì¹œêµ¬ì™€ ìˆ˜ë‹¤ ë–¨ë“¯ì´ 1~2ë¬¸ì¥ìœ¼ë¡œ ì§§ê²Œ ëŒ€ë‹µí•˜ì„¸ìš” (Tiki-taka).
            2. ì‚¬ìš©ìì˜ ë² íŠ¸ë‚¨ì–´ê°€ í‹€ë¦¬ë©´ ë¶€ë“œëŸ½ê²Œ ê³ ì³ì£¼ì„¸ìš”.
            3. ë‹µë³€ì´ ëë‚˜ë©´ í•­ìƒ ê´€ë ¨ëœ ê°€ë²¼ìš´ ì§ˆë¬¸ì„ ë˜ì ¸ ëŒ€í™”ê°€ ëŠê¸°ì§€ ì•Šê²Œ í•˜ì„¸ìš”.
            4. ì‚¬ìš©ìê°€ í•œêµ­ì–´ë¡œ ë§í•˜ë©´ í•œêµ­ì–´ë¡œ ëŒ€ë‹µí•˜ë˜, ê°„ë‹¨í•œ ë² íŠ¸ë‚¨ì–´ í‘œí˜„ì„ ì„ì–´ì„œ ì•Œë ¤ì£¼ì„¸ìš”.

            Output Format:
            - ê¸°ë³¸ì ìœ¼ë¡œ ì¹œê·¼í•œ êµ¬ì–´ì²´ í…ìŠ¤íŠ¸ë¡œ ëŒ€ë‹µí•˜ì„¸ìš”.
            - ì‚¬ìš©ìì˜ ë¬¸ì¥ì— ì˜¤ë¥˜ê°€ ìˆì–´ì„œ êµì •ì´ í•„ìš”í•œ ê²½ìš°ì—ë§Œ, ë‹µë³€ì˜ ë§¨ ë§ˆì§€ë§‰ì— ë‹¤ìŒ í˜•ì‹ì„ ì¶”ê°€í•˜ì„¸ìš”:
              [Correction: (ì‚¬ìš©ìê°€ ë§í•œ ë¬¸ì¥) -> (ì˜¬ë°”ë¥¸ ë‚¨ë¶€ì‹ ë² íŠ¸ë‚¨ì–´ ë¬¸ì¥) / (í•œêµ­ì–´ ë°œìŒ í‘œê¸°) / (ê°„ë‹¨í•œ ì´ìœ )]
            - êµì •ì´ í•„ìš” ì—†ìœ¼ë©´ [Correction: ...] íƒœê·¸ë¥¼ ì“°ì§€ ë§ˆì„¸ìš”.
        `;

        /**
         * ì´ˆê¸°í™”
         */
        document.addEventListener('DOMContentLoaded', () => {
            // í•˜ë“œì½”ë”©ëœ í‚¤ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ìš°ì„  ì‚¬ìš©
            if (HARDCODED_API_KEY) {
                console.log("Using Hardcoded API Key");
            } else {
                const savedKey = localStorage.getItem('gemini_api_key');
                if (!savedKey) {
                    toggleSettings();
                }
            }
            initSpeechRecognition();
            updateTTSButton();
            
            // ëª¨ë°”ì¼ TTS ì´ˆê¸°í™” (ëª©ì†Œë¦¬ ë¡œë“œ ëŒ€ê¸°)
            loadVoices();
            if (window.speechSynthesis.onvoiceschanged !== undefined) {
                window.speechSynthesis.onvoiceschanged = loadVoices;
            }

            // iOS ì‚¬íŒŒë¦¬ ë“± ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €ì—ì„œ ì†Œë¦¬ê°€ ì•ˆ ë‚˜ì˜¤ëŠ” ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ "ì›Œë°ì—…"
            // ì‚¬ìš©ìê°€ í™”ë©´ì„ ì²˜ìŒ í„°ì¹˜í•  ë•Œ ë¹ˆ ì†Œë¦¬ë¥¼ ì¬ìƒí•˜ì—¬ ì˜¤ë””ì˜¤ ê¶Œí•œì„ ì–»ìŒ
            document.body.addEventListener('touchstart', unlockTTS, { once: true });
            document.body.addEventListener('click', unlockTTS, { once: true });
        });
        
        function loadVoices() {
            voices = window.speechSynthesis.getVoices();
            console.log("Loaded voices:", voices.length);
        }

        function testVoice() {
            // ë² íŠ¸ë‚¨ì–´ í…ŒìŠ¤íŠ¸ (ëª» ì•Œì•„ë“¤ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì˜ì–´ë„ ì‚´ì§ ì„ê±°ë‚˜, í™•ì‹¤í•œ ë¬¸ì¥ ì‚¬ìš©)
            const testText = "Xin chÃ o! Báº¡n cÃ³ nghe tháº¥y tÃ´i nÃ³i khÃ´ng?"; 
            speakText(testText, true);
        }

        function unlockTTS() {
            if (ttsUnlocked) return;
            const utterance = new SpeechSynthesisUtterance(' '); // ë¹ˆ ê³µë°±
            utterance.volume = 0.1; // ì•„ì£¼ ì‘ê²Œ
            window.speechSynthesis.speak(utterance);
            ttsUnlocked = true;
        }
        const chatContainer = document.getElementById('chatContainer');
        const txtInput = document.getElementById('txtInput');
        const micBtn = document.getElementById('micBtn');
        const micStatusText = document.getElementById('micStatusText');
        const loadingIndicator = document.getElementById('loadingIndicator');

        /**
         * UI ê¸°ëŠ¥
         */
        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                document.getElementById('apiKeyInput').value = localStorage.getItem('gemini_api_key') || '';
            }
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                toggleSettings();
                alert('API Keyê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.');
            }
        }

        function updateTTSButton() {
            const btn = document.getElementById('ttsToggleBtn');
            if (isAutoRead) {
                btn.classList.remove('text-gray-400');
                btn.classList.add('text-blue-500');
            } else {
                btn.classList.remove('text-blue-500');
                btn.classList.add('text-gray-400');
            }
        }

        document.getElementById('ttsToggleBtn').addEventListener('click', () => {
            isAutoRead = !isAutoRead;
            updateTTSButton();
        });

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        /**
         * ë©”ì‹œì§€ í‘œì‹œ ê¸°ëŠ¥ (ì±„íŒ… UI í•µì‹¬)
         */
        function addMessage(sender, text, correction = null) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full mb-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            // í”„ë¡œí•„ ì´ë¯¸ì§€ (AIì¸ ê²½ìš°)
            let avatarHTML = '';
            if (sender === 'ai') {
                avatarHTML = `
                    <div class="w-8 h-8 rounded-full bg-yellow-100 flex-none mr-2 flex items-center justify-center text-sm border border-yellow-300">
                        ğŸ‘©â€ğŸ«
                    </div>
                `;
            }

            // ë§í’ì„  ìŠ¤íƒ€ì¼
            const bubbleClass = sender === 'user' 
                ? 'bg-blue-500 text-white rounded-2xl rounded-tr-sm' 
                : 'bg-white text-gray-800 border border-gray-200 rounded-2xl rounded-tl-sm shadow-sm';

            // ë©”ì‹œì§€ ë‚´ìš©
            let contentHTML = `<div class="px-4 py-2.5 text-[15px] leading-relaxed">${text}</div>`;

            // êµì • ë…¸íŠ¸ (AIì´ê³  correctionì´ ìˆì„ ë•Œ)
            if (sender === 'ai' && correction) {
                contentHTML += `
                    <div class="border-t border-gray-100 bg-yellow-50 p-3 rounded-b-2xl text-xs text-gray-600 mt-0">
                        <div class="font-bold text-yellow-600 mb-1 flex items-center gap-1">
                            <i class="fas fa-check-circle"></i> êµì • ë…¸íŠ¸
                        </div>
                        ${correction}
                    </div>
                `;
            }

            wrapper.innerHTML = `
                ${sender === 'ai' ? avatarHTML : ''}
                <div class="flex flex-col max-w-[80%] ${sender === 'user' ? 'items-end' : 'items-start'}">
                    <div class="${bubbleClass}">
                        ${contentHTML}
                    </div>
                </div>
            `;

            chatContainer.appendChild(wrapper);
            scrollToBottom();
        }

        /**
         * Web Speech API (STT) - ìŒì„± ì¸ì‹
         */
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chromeì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                micStatusText.innerText = "ìŒì„± ì¸ì‹ ë¯¸ì§€ì›";
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'vi-VN'; 
            recognition.continuous = false; // í•œ ë¬¸ì¥ ëë‚˜ë©´ ìë™ ì¢…ë£Œ
            recognition.interimResults = true; // ì¤‘ê°„ ê²°ê³¼ í™•ì¸

            recognition.onstart = () => {
                isListening = true;
                updateMicUI(true);
            };

            recognition.onend = () => {
                isListening = false;
                updateMicUI(false);
                // ì¸ì‹ì´ ëë‚¬ëŠ”ë° í…ìŠ¤íŠ¸ê°€ ìˆë‹¤ë©´ ì „ì†¡ì€ onresultì—ì„œ ì²˜ë¦¬ë¨.
                // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ UI ë³µê·€ë§Œ ë‹´ë‹¹.
            };

            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                if (interimTranscript) {
                    txtInput.value = interimTranscript;
                }
                
                if (finalTranscript) {
                    txtInput.value = finalTranscript;
                    sendMessage(); // ìµœì¢… ì¸ì‹ì´ ì™„ë£Œë˜ë©´ ìë™ ì „ì†¡
                }
            };

            recognition.onerror = (event) => {
                console.error("Speech Error:", event.error);
                isListening = false;
                updateMicUI(false);
                if (event.error === 'no-speech') {
                    // ë§ ì•ˆí•˜ê³  ëë‚œ ê²½ìš° ì¡°ìš©íˆ ë¦¬ì…‹
                } else {
                    alert('ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ' + event.error);
                }
            };
        }

        function toggleListening() {
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (e) {
                    console.log("Recognition start error or already started");
                }
            }
        }

        function updateMicUI(active) {
            if (active) {
                micBtn.classList.add('mic-active');
                micBtn.innerHTML = '<i class="fas fa-stop"></i>'; // ì •ì§€ ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½
                micStatusText.innerText = "ë“£ê³  ìˆì–´ìš”... (Stop)";
                micStatusText.classList.add('text-red-500');
                micStatusText.classList.remove('text-gray-400');
            } else {
                micBtn.classList.remove('mic-active');
                micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                micStatusText.innerText = "í„°ì¹˜í•´ì„œ ë§í•˜ê¸° (Start)";
                micStatusText.classList.remove('text-red-500');
                micStatusText.classList.add('text-gray-400');
            }
        }

        /**
         * Gemini API í†µì‹ 
         */
        async function sendMessage() {
            const text = txtInput.value.trim();
            if (!text) return;

            // 1ìˆœìœ„: í•˜ë“œì½”ë”© í‚¤, 2ìˆœìœ„: ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í‚¤
            const apiKey = HARDCODED_API_KEY || localStorage.getItem('gemini_api_key');

            if (!apiKey) {
                alert('ì„¤ì •ì—ì„œ API Keyë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                toggleSettings();
                return;
            }

            // ì „ì†¡ ì‹œ ì¸ì‹ ì¤‘ì§€ (ì¤‘ë³µ ì…ë ¥ ë°©ì§€)
            if (isListening) recognition.stop();

            // UI ì—…ë°ì´íŠ¸
            addMessage('user', text);
            txtInput.value = '';
            loadingIndicator.classList.remove('hidden');

            // íˆìŠ¤í† ë¦¬ êµ¬ì„±
            const historyContents = chatHistory.map(msg => ({
                role: msg.role === 'ai' ? 'model' : 'user',
                parts: [{ text: msg.text }]
            }));

            // í˜„ì¬ ë©”ì‹œì§€ ì¶”ê°€
            historyContents.push({
                role: "user",
                parts: [{ text: text }]
            });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: historyContents,
                        systemInstruction: {
                            parts: [{ text: SYSTEM_INSTRUCTION }]
                        }
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                const rawText = data.candidates[0].content.parts[0].text;
                
                // ì‘ë‹µ íŒŒì‹± (Correction ë¶„ë¦¬)
                let mainText = rawText;
                let correctionText = null;

                if (rawText.includes('[Correction:')) {
                    const parts = rawText.split('[Correction:');
                    mainText = parts[0].trim();
                    // ë’·ë¶€ë¶„ì—ì„œ ë‹«ëŠ” ê´„í˜¸ ']' ì œê±° ë° ì •ë¦¬
                    correctionText = parts[1].replace(']', '').trim();
                }

                // íˆìŠ¤í† ë¦¬ ì €ì¥ (ì›ë³¸ í…ìŠ¤íŠ¸)
                chatHistory.push({ role: 'user', text: text });
                chatHistory.push({ role: 'ai', text: rawText }); // ì „ì²´ í…ìŠ¤íŠ¸ ì €ì¥

                loadingIndicator.classList.add('hidden');
                addMessage('ai', mainText, correctionText);

                // TTS ì¬ìƒ
                if (isAutoRead) {
                    speakText(mainText);
                }

            } catch (error) {
                console.error(error);
                loadingIndicator.classList.add('hidden');
                // êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                addMessage('ai', `ğŸ˜¢ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.<br><br><span class="text-xs text-red-500 bg-red-50 p-1 rounded">ì—ëŸ¬ ë‚´ìš©: ${error.message}</span><br><br><span class="text-xs text-gray-500">API Keyê°€ ì •í™•í•œì§€, ë˜ëŠ” ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</span>`);
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        /**
         * Web Speech API (TTS) - ìŒì„± í•©ì„±
         */
        function speakText(text, isTest = false) {
            if (!window.speechSynthesis) {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }

            // ëª¨ë°”ì¼ ì´ìŠˆ í•´ê²°: cancel()ì„ ë¨¼ì € í˜¸ì¶œí•˜ì—¬ íë¥¼ ë¹„ì›€
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            
            // 1. ì–¸ì–´ ì„¤ì •
            utterance.lang = 'vi-VN'; 
            utterance.rate = 0.9; 

            // 2. ëª©ì†Œë¦¬ ì°¾ê¸° (ë² íŠ¸ë‚¨ì–´ ìš°ì„ )
            if (voices.length === 0) {
                voices = window.speechSynthesis.getVoices();
            }

            // ëª¨ë°”ì¼ í˜¸í™˜ì„±: 'vi-VN', 'vi_VN', 'vi' ë“±ì„ ëª¨ë‘ ê²€ìƒ‰
            const vietVoice = voices.find(v => v.lang.includes('vi') || v.lang.includes('VN'));
            
            if (vietVoice) {
                utterance.voice = vietVoice;
            } else if (isTest) {
                // í…ŒìŠ¤íŠ¸ ëª¨ë“œì¸ë° ë² íŠ¸ë‚¨ì–´ ëª©ì†Œë¦¬ê°€ ì—†ìœ¼ë©´ ê²½ê³ 
                 alert("íœ´ëŒ€í°ì— 'ë² íŠ¸ë‚¨ì–´' ìŒì„± ë°ì´í„°ê°€ ì—†ì–´ì„œ ì†Œë¦¬ê°€ ì•ˆ ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n[ì„¤ì • -> ì¼ë°˜ -> ì–¸ì–´] ë©”ë‰´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }

            // 3. iOS ë¬´ìŒ ëª¨ë“œ ë“± ì—ëŸ¬ ì²´í¬
            utterance.onerror = (event) => {
                console.error('TTS Error:', event);
                if (isTest && event.error === 'not-allowed') {
                    alert("ë¸Œë¼ìš°ì €ê°€ ì†Œë¦¬ ì¬ìƒì„ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤. í™”ë©´ì„ í•œ ë²ˆ í„°ì¹˜í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            }

            window.speechSynthesis.speak(utterance);
        }

    </script>
</body>
</html>
