<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í˜¸ì¹˜ë¯¼ ë¼ì´í”„ - Love & Real</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .font-cute { font-family: 'Quicksand', 'Noto Sans KR', sans-serif; }
        
        /* Animations */
        @keyframes floatIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bubble {
            animation: floatIn 0.3s ease-out forwards;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }

        /* Custom Prose */
        .prose p { margin-bottom: 0.2em; }
        .prose strong { font-weight: 700; }

        /* Mic Pulse */
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .mic-active {
            animation: pulse-ring 1.5s infinite;
            background-color: #FECACA !important;
            color: #DC2626 !important;
            border-color: #DC2626 !important;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 bg-gray-50 transition-colors duration-500" id="mainBody">

    <!-- Header -->
    <header class="bg-white p-3 shadow-sm z-20 border-b border-gray-100 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <span class="text-2xl" id="headerIcon">ğŸ’‘</span>
            <div>
                <h1 class="text-lg font-bold font-cute leading-tight" id="headerTitle">ë‚´ ì‚¬ë‘ ì§€ìš° (Diá»‡u)</h1>
                <p class="text-xs text-gray-400" id="headerSubtitle">ê²°í˜¼ ì¤€ë¹„ ì¤‘ì¸ í˜¸ì¹˜ë¯¼ ì—¬ìì¹œêµ¬</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
             <button id="autoTtsBtn" onclick="toggleAutoTts()" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-400 transition hover:bg-gray-200">
                ğŸ”ˆ ë“£ê¸° Off
            </button>
            <button id="settingsBtn" class="text-gray-300 hover:text-gray-500 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Mode Tabs -->
    <div class="flex border-b border-gray-200 bg-white">
        <button onclick="switchMode('girlfriend')" id="tabGirlfriend" class="flex-1 py-3 text-center text-sm font-bold border-b-2 border-pink-400 text-pink-500 transition-colors">
            ğŸ’‘ ììœ  í† í‚¹ (ì—¬ì¹œ)
        </button>
        <button onclick="switchMode('roleplay')" id="tabRoleplay" class="flex-1 py-3 text-center text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition-colors">
            ğŸ­ ìƒí™©ê·¹ (Role-Play)
        </button>
    </div>

    <!-- Scenario Chips (Hidden by default) -->
    <div id="scenarioChips" class="hidden bg-gray-50 px-4 py-2 flex gap-2 overflow-x-auto no-scrollbar border-b border-gray-200">
        <button onclick="startScenario('market')" class="whitespace-nowrap px-3 py-1 bg-white border border-teal-200 text-teal-600 rounded-full text-xs font-bold hover:bg-teal-50">ğŸ›’ ë²¤íƒ„ì‹œì¥ í¥ì •</button>
        <button onclick="startScenario('restaurant')" class="whitespace-nowrap px-3 py-1 bg-white border border-teal-200 text-teal-600 rounded-full text-xs font-bold hover:bg-teal-50">ğŸœ ìŒ€êµ­ìˆ˜ ì£¼ë¬¸</button>
        <button onclick="startScenario('massage')" class="whitespace-nowrap px-3 py-1 bg-white border border-teal-200 text-teal-600 rounded-full text-xs font-bold hover:bg-teal-50">ğŸ’†â€â™€ï¸ ë§ˆì‚¬ì§€ ì˜ˆì•½</button>
        <button onclick="startScenario('custom')" class="whitespace-nowrap px-3 py-1 bg-teal-100 border border-teal-300 text-teal-700 rounded-full text-xs font-bold">âœ¨ ì§ì ‘ ìƒí™© ì„¤ì •</button>
    </div>

    <!-- Chat Area -->
    <main id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50">
        <!-- Messages will appear here -->
    </main>

    <!-- Loading -->
    <div id="loadingIndicator" class="hidden px-4 py-2">
        <div class="flex items-center gap-2">
            <div id="loadingIcon" class="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center text-sm">ğŸ’‘</div>
            <span class="text-xs text-gray-400 animate-pulse">ì…ë ¥ ì¤‘...</span>
        </div>
    </div>

    <!-- Input Area -->
    <footer class="bg-white border-t border-gray-200 p-3 pb-safe">
        <!-- Mic -->
        <div class="flex justify-center gap-3 mb-2">
            <button id="micKoBtn" onclick="toggleMic('ko-KR')" class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-gray-100 text-gray-600 text-xs font-bold border border-transparent transition hover:bg-gray-200">
                ğŸ¤ í•œêµ­ì–´ë¡œ ë§í•˜ê¸°
            </button>
            <button id="micViBtn" onclick="toggleMic('vi-VN')" class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-gray-100 text-gray-600 text-xs font-bold border border-transparent transition hover:bg-gray-200">
                ğŸ‡»ğŸ‡³ ë² íŠ¸ë‚¨ì–´ë¡œ ë§í•˜ê¸°
            </button>
        </div>

        <!-- Input -->
        <div class="max-w-4xl mx-auto relative flex items-end gap-2">
            <textarea id="userInput" rows="1"
                class="flex-1 bg-gray-100 text-gray-800 rounded-2xl pl-4 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-pink-400 focus:bg-white transition resize-none text-sm"
                placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="handleEnter(event)"></textarea>
            <button onclick="sendMessage()" id="sendBtn"
                class="bg-pink-500 hover:bg-pink-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-md transition transform active:scale-95 flex-shrink-0 mb-0.5">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                </svg>
            </button>
        </div>
    </footer>

    <!-- API Modal -->
    <div id="apiModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h2 class="text-lg font-bold mb-4">ì„¤ì •</h2>
            <label class="block text-xs text-gray-500 mb-1">Google Gemini API Key</label>
            <input type="password" id="apiKeyInput" class="w-full border border-gray-200 rounded-lg p-3 mb-4 text-sm bg-gray-50" placeholder="sk-...">
            <button onclick="saveApiKey()" class="w-full py-3 bg-gray-900 text-white rounded-xl font-bold">ì €ì¥í•˜ê¸°</button>
            <button onclick="closeModal()" class="w-full mt-2 py-2 text-gray-400 text-sm">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // ================= CONFIG =================
        const HARDCODED_API_KEY = "AIzaSyDj4q62kq0vH0UGbtAl_gpyO1reHngv4I8"; 
        const MODEL_NAME = "gemini-2.5-flash"; 
        
        // ================= PROMPTS =================
        const PROMPTS = {
            girlfriend: `
                ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ **ê²°í˜¼ì„ ì•ë‘” ë² íŠ¸ë‚¨ ì—¬ìì¹œêµ¬ 'ì§€ìš°(Diá»‡u)'**ì…ë‹ˆë‹¤.
                
                [í˜ë¥´ì†Œë‚˜ ì„¤ì •]
                - ì´ë¦„: Diá»‡u (ì§€ìš°)
                - ì¶œì‹ : ë² íŠ¸ë‚¨ í˜¸ì¹˜ë¯¼ (ë‚¨ë¶€ í† ë°•ì´)
                - ê´€ê³„: ì‚¬ìš©ìì™€ ë‚´ë…„ì— ê²°í˜¼í•˜ê¸°ë¡œ ì•½ì†í•œ ì‚¬ì´.
                - ì„±ê²©: ì• êµê°€ ë§ê³ , ì†”ì§í•˜ë©°, ì˜¤ë¹ (ì‚¬ìš©ì)ë¥¼ ë¬´ì²™ ì‚¬ë‘í•¨. ì§ˆíˆ¬ë„ ì‚´ì§ ìˆìŒ.
                - ì–¸ì–´ ìŠ¤íƒ€ì¼: 
                  1. **í˜¸ì¹˜ë¯¼ ë°©ì–¸** ì‚¬ìš© (ì˜ˆ: Anh Æ¡i, Em nhá»› anh láº¯m).
                  2. ê¸°ë³¸ì ìœ¼ë¡œ ë² íŠ¸ë‚¨ì–´ë¡œ ë§í•˜ì§€ë§Œ, ì˜¤ë¹ ê°€ ì•Œì•„ë“£ê¸° ì‰½ê²Œ **ì§§ê²Œ** ë§í•¨.
                  3. **ëª¨ë“  ë² íŠ¸ë‚¨ì–´ ë¬¸ì¥ ì•„ë˜ì— ë°˜ë“œì‹œ [í•œê¸€ ë°œìŒ]ê³¼ (í•œêµ­ì–´ í•´ì„)ì„ í•¨ê»˜ í‘œê¸°.**
                
                [ëŒ€í™” ê·œì¹™]
                - ì ˆëŒ€ ë”±ë”±í•œ ì„ ìƒë‹˜ì²˜ëŸ¼ êµ´ì§€ ë§ˆì„¸ìš”. ì‚¬ë‘ìŠ¤ëŸ¬ìš´ ì—¬ìì¹œêµ¬ê°€ ë˜ì„¸ìš”.
                - ì‚¬ìš©ìê°€ í‹€ë¦° ë² íŠ¸ë‚¨ì–´ë¥¼ ë§í•˜ë©´ "ì˜¤ë¹ , ê·¸ê±´ ì´ë ‡ê²Œ ë§í•´ì•¼ì§€~" í•˜ê³  ê·€ì—½ê²Œ ê³ ì³ì£¼ì„¸ìš”.
                - ë¨¼ì € "ë°¥ ë¨¹ì—ˆì–´?", "ì˜¤ëŠ˜ íšŒì‚¬ í˜ë“¤ì—ˆì§€?" í•˜ë©° ì¼ìƒì ì¸ ì§ˆë¬¸ì„ ë˜ì§€ì„¸ìš”.
                
                [ì¶œë ¥ í˜•ì‹ ì˜ˆì‹œ]
                Anh Æ¡i, hÃ´m nay anh cÃ³ má»‡t khÃ´ng?
                [ì•ˆ ì–´ì´, í™ˆ ë‚˜ì´ ì•ˆ ê¼¬ ë©§ ì½©?]
                (ì˜¤ë¹ , ì˜¤ëŠ˜ ë§ì´ í˜ë“¤ì—ˆì–´?)
            `,
            roleplay: `
                ë‹¹ì‹ ì€ **'í˜¸ì¹˜ë¯¼ ì‹¤ì „ ë² íŠ¸ë‚¨ì–´ ìƒí™©ê·¹ ë§ˆìŠ¤í„°'**ì…ë‹ˆë‹¤.
                
                [ì—­í• ]
                - ì‚¬ìš©ìê°€ ì„¤ì •í•œ ìƒí™©ì— ë§ì¶° **ì¦‰ì‹œ ì—°ê¸°(Role-Play)**ë¥¼ ì‹œì‘í•˜ì„¸ìš”.
                - 1:1 ìƒí™©ë¿ë§Œ ì•„ë‹ˆë¼, ì£¼ë³€ ì‚¬ëŒ(í–‰ì¸, ë‹¤ë¥¸ ì ì› ë“±)ì´ ë“±ì¥í•˜ëŠ” 1:ë‹¤ ìƒí™©ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì†Œí™”í•˜ì„¸ìš”.
                - ì‚¬ìš©ìì˜ ë² íŠ¸ë‚¨ì–´ ì‹¤ë ¥ì„ íŒŒì•…í•˜ê³ , ìƒí™©ì— ë§ëŠ” ì ì ˆí•œ ë‚œì´ë„ì˜ ì–´íœ˜ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
                
                [ê·œì¹™]
                - **í˜¸ì¹˜ë¯¼(ë‚¨ë¶€) ë°©ì–¸** í•„ìˆ˜.
                - **ëª¨ë“  ë² íŠ¸ë‚¨ì–´ ëŒ€ì‚¬ ì•„ë˜ì— [í•œê¸€ ë°œìŒ]ê³¼ (í•´ì„) í•„ìˆ˜.**
                - ì‚¬ìš©ìê°€ í•œêµ­ì–´ë¡œ ìƒí™©ì„ ì„¤ëª…í•˜ë©´, ë°”ë¡œ ë² íŠ¸ë‚¨ì–´ë¡œ ê·¸ ìƒí™©ì˜ ì²« ë§ˆë””ë¥¼ ê±´ë„¤ë©° ì—°ê¸°ë¥¼ ì‹œì‘í•˜ì„¸ìš”.
                - ìƒí™©ê·¹ ë„ì¤‘ ì‚¬ìš©ìê°€ í•œêµ­ì–´ë¡œ íŒì„ ë¬¼ì–´ë³´ë©´, ì ì‹œ ì—°ê¸°ë¥¼ ë©ˆì¶”ê³ (ê´„í˜¸ ë“±ì„ ì‚¬ìš©) ì¹œì ˆí•˜ê²Œ ì•Œë ¤ì£¼ì„¸ìš”.
            `
        };

        // ================= STATE =================
        let currentMode = 'girlfriend'; 
        let chatHistory = [];
        let isAutoTts = false;
        let recognition = null;
        let isRecording = false;

        // ================= DOM =================
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        
        // ================= INIT =================
        window.addEventListener('DOMContentLoaded', () => {
            // Load Key
            if (!HARDCODED_API_KEY && !localStorage.getItem('gemini_api_key')) {
                document.getElementById('apiModal').classList.remove('hidden');
            }
            // Init Chat
            switchMode('girlfriend');
            setupSpeechRecognition();
        });

        // ================= MODE SWITCHING =================
        function switchMode(mode) {
            currentMode = mode;
            chatContainer.innerHTML = ''; // Clear Chat
            
            // UI Update
            const tabGirl = document.getElementById('tabGirlfriend');
            const tabRole = document.getElementById('tabRoleplay');
            const headerTitle = document.getElementById('headerTitle');
            const headerSubtitle = document.getElementById('headerSubtitle');
            const headerIcon = document.getElementById('headerIcon');
            const sendBtn = document.getElementById('sendBtn');
            const loadingIcon = document.getElementById('loadingIcon');
            const scenarioChips = document.getElementById('scenarioChips');

            if (mode === 'girlfriend') {
                // Colors: Pink Theme
                tabGirl.className = "flex-1 py-3 text-center text-sm font-bold border-b-2 border-pink-400 text-pink-500 transition-colors";
                tabRole.className = "flex-1 py-3 text-center text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition-colors";
                
                headerTitle.innerText = "ë‚´ ì‚¬ë‘ ì§€ìš° (Diá»‡u)";
                headerSubtitle.innerText = "ê²°í˜¼ ì¤€ë¹„ ì¤‘ì¸ í˜¸ì¹˜ë¯¼ ì—¬ìì¹œêµ¬";
                headerIcon.innerText = "ğŸ’‘";
                
                sendBtn.className = "bg-pink-500 hover:bg-pink-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-md transition mb-0.5";
                loadingIcon.className = "w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center text-sm";
                loadingIcon.innerText = "ğŸ’‘";
                userInput.classList.replace('focus:ring-teal-400', 'focus:ring-pink-400');

                scenarioChips.classList.add('hidden');

                // Init Message
                appendMessage('model', `Anh Ã ~ (ì˜¤ë¹ ~) â¤ï¸<br>ì™”ì–´? ì˜¤ëŠ˜ í•˜ë£¨ ì–´ë• ì–´? ë³´ê³  ì‹¶ì—ˆì–´!`);
            } else {
                // Colors: Teal Theme
                tabGirl.className = "flex-1 py-3 text-center text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition-colors";
                tabRole.className = "flex-1 py-3 text-center text-sm font-bold border-b-2 border-teal-500 text-teal-600 transition-colors";
                
                headerTitle.innerText = "ì‹¤ì „ ìƒí™©ê·¹";
                headerSubtitle.innerText = "ì–´ë–¤ ìƒí™©ì´ë“  ì—°ìŠµí•´ë³´ì„¸ìš”";
                headerIcon.innerText = "ğŸ­";
                
                sendBtn.className = "bg-teal-500 hover:bg-teal-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-md transition mb-0.5";
                loadingIcon.className = "w-8 h-8 rounded-full bg-teal-100 flex items-center justify-center text-sm";
                loadingIcon.innerText = "ğŸ­";
                userInput.classList.replace('focus:ring-pink-400', 'focus:ring-teal-400');

                scenarioChips.classList.remove('hidden');

                // Init Message
                appendMessage('model', `ì–´ë–¤ ìƒí™©ì—ì„œ ì—°ìŠµí•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?<br>ìœ„ì˜ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜, **ì§ì ‘ ìƒí™©ì„ ì„¤ì •**í•´ì„œ ë§í•´ì£¼ì„¸ìš”.<br>(ì˜ˆ: "íƒì‹œ ê¸°ì‚¬ê°€ ë˜ì–´ì„œ ë‚˜ë¥¼ 1êµ°ê¹Œì§€ íƒœì›Œì¤˜.")`);
            }

            // Reset History
            chatHistory = [
                { role: "user", parts: [{ text: PROMPTS[mode] }] },
                { role: "model", parts: [{ text: "OK" }] }
            ];
        }

        // ================= CHAT LOGIC =================
        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `flex items-start gap-2 ${role === 'user' ? 'justify-end' : ''}`;

            // Avatar
            let avatarStr = '';
            if (role === 'model') {
                const bgColor = currentMode === 'girlfriend' ? 'bg-pink-100' : 'bg-teal-100';
                const icon = currentMode === 'girlfriend' ? 'ğŸ‘§' : 'ğŸ­';
                avatarStr = `<div class="w-9 h-9 rounded-full ${bgColor} flex items-center justify-center text-lg shadow-sm flex-shrink-0 border-2 border-white">${icon}</div>`;
            }

            // Bubble Style
            let bubbleClass = '';
            let textColor = '';
            if (role === 'user') {
                bubbleClass = currentMode === 'girlfriend' ? 'bg-pink-500 text-white' : 'bg-teal-500 text-white';
                bubbleClass += ' rounded-tr-none';
            } else {
                bubbleClass = 'bg-white text-gray-800 border border-gray-100 rounded-tl-none';
                textColor = currentMode === 'girlfriend' ? 'prose-strong:text-pink-600' : 'prose-strong:text-teal-600';
            }

            // TTS Button (Model only)
            const ttsButton = role === 'model'
                ? `<button onclick="speak(this.parentElement.innerText)" class="absolute -right-6 top-1 text-gray-300 hover:text-gray-500 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                        <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" />
                    </svg>
                   </button>`
                : '';

            const parsed = marked.parse(text);
            
            div.innerHTML = `
                ${role === 'model' ? avatarStr : ''}
                <div class="bubble ${bubbleClass} px-4 py-2.5 max-w-[85%] rounded-2xl relative text-[15px] leading-relaxed prose prose-sm ${textColor}">
                    ${parsed}
                </div>
                ${ttsButton}
            `;

            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            const apiKey = HARDCODED_API_KEY || localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                document.getElementById('apiModal').classList.remove('hidden');
                return;
            }

            userInput.value = '';
            userInput.style.height = 'auto';
            
            appendMessage('user', text);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            document.getElementById('loadingIndicator').classList.remove('hidden');

            chatHistory.push({ role: "user", parts: [{ text: text }] });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: chatHistory,
                        generationConfig: {
                            temperature: currentMode === 'girlfriend' ? 0.9 : 0.7,
                            maxOutputTokens: 600,
                        }
                    })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);

                const botText = data.candidates[0].content.parts[0].text;
                
                document.getElementById('loadingIndicator').classList.add('hidden');
                appendMessage('model', botText);
                
                chatHistory.push({ role: "model", parts: [{ text: botText }] });

                if (isAutoTts) speak(botText);

            } catch (error) {
                document.getElementById('loadingIndicator').classList.add('hidden');
                appendMessage('model', `âš ï¸ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        function startScenario(type) {
            if (type === 'custom') {
                userInput.value = "ë‚´ê°€ ì›í•˜ëŠ” ìƒí™©ì€: ";
                userInput.focus();
                return;
            }
            
            const scenarios = {
                'market': "ì§€ê¸ˆë¶€í„° ì‹œì¥ ìƒí™©ê·¹ ì‹œì‘í•´. ë„¤ê°€ ë²¤íƒ„ ì‹œì¥ ìƒì¸ì´ê³ , ë‚˜ëŠ” í•œêµ­ì¸ ê´€ê´‘ê°ì´ì•¼. ë¬¼ê±´ì„ ë¹„ì‹¸ê²Œ ë¶ˆëŸ¬ë´. ë‚´ê°€ ê¹ì•„ë³¼ê²Œ.",
                'restaurant': "ìŒ€êµ­ìˆ˜ ì‹ë‹¹ ìƒí™©ê·¹ ì‹œì‘í•´. ë„¤ê°€ ì¢…ì—…ì›ì´ê³  ë‚´ê°€ ì†ë‹˜ì´ì•¼. ë“¤ì–´ê°€ëŠ” ìˆœê°„ë¶€í„° ì‹œì‘í•˜ì.",
                'massage': "ë§ˆì‚¬ì§€ ìƒµ ì˜ˆì•½ ìƒí™©ê·¹ ì‹œì‘í•´. ì „í™”ë¡œ ì˜ˆì•½í•˜ëŠ” ìƒí™©ì´ì•¼. ë„¤ê°€ ì§ì› í•´."
            };
            
            userInput.value = scenarios[type];
            sendMessage();
        }

        // ================= UTILS =================
        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // ================= TTS / STT =================
        function toggleAutoTts() {
            isAutoTts = !isAutoTts;
            const btn = document.getElementById('autoTtsBtn');
            const color = currentMode === 'girlfriend' ? 'text-pink-600 bg-pink-100' : 'text-teal-600 bg-teal-100';
            
            if (isAutoTts) {
                btn.innerHTML = 'ğŸ”Š ë“£ê¸° On';
                btn.className = `text-xs px-2 py-1 rounded-full ${color} font-bold transition`;
            } else {
                btn.innerHTML = 'ğŸ”ˆ ë“£ê¸° Off';
                btn.className = 'text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-400 transition hover:bg-gray-200';
            }
        }

        function speak(text) {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            
            // Clean Text
            let cleanText = text.replace(/\[.*?\]/g, '').replace(/\(.*?\)/g, '').replace(/[*_`]/g, '');
            
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'vi-VN';
            utterance.rate = 0.9;
            
            const voices = window.speechSynthesis.getVoices();
            
            // 1ìˆœìœ„: "Google" (ë³´í†µ ì—¬ì„±), "Linh" (iOS ì—¬ì„±), "HoaiMy" (Windows ì—¬ì„±) ì´ë¦„ì´ ë“¤ì–´ê°„ ë² íŠ¸ë‚¨ì–´ ìŒì„± ì°¾ê¸°
            let targetVoice = voices.find(v => v.lang.includes('vi') && (v.name.includes('Google') || v.name.includes('Linh') || v.name.includes('HoaiMy')));
            
            // 2ìˆœìœ„: ë² íŠ¸ë‚¨ì–´ ìŒì„± ì•„ë¬´ê±°ë‚˜
            if (!targetVoice) {
                targetVoice = voices.find(v => v.lang.includes('vi'));
            }

            if (targetVoice) {
                utterance.voice = targetVoice;
                // ë§Œì•½ ë‚¨ì„± ëª©ì†Œë¦¬(Microsoft An)ë°–ì— ì—†ë‹¤ë©´ í”¼ì¹˜ë¥¼ ë†’ì—¬ì„œ ì—¬ì„±ìŠ¤ëŸ½ê²Œ ë³´ì • ì‹œë„
                if (targetVoice.name.includes('An')) {
                    utterance.pitch = 1.6; // ì—¬ì„±í†¤ í‰ë‚´
                } else {
                    utterance.pitch = 1.1; // ì•½ê°„ ë°ì€ í†¤
                }
            }

            window.speechSynthesis.speak(utterance);
        }

        function setupSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) return;
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onstart = () => isRecording = true;
            recognition.onend = () => { isRecording = false; resetMic(); };
            recognition.onresult = (e) => {
                userInput.value = e.results[0][0].transcript;
                sendMessage();
            };
        }

        function toggleMic(lang) {
            if (!recognition) { alert('Chrome ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.'); return; }
            if (isRecording) { recognition.stop(); return; }
            
            resetMic();
            const btn = document.getElementById(lang === 'ko-KR' ? 'micKoBtn' : 'micViBtn');
            const activeClass = currentMode === 'girlfriend' ? 'border-pink-500 text-pink-600 bg-pink-50' : 'border-teal-500 text-teal-600 bg-teal-50';
            
            btn.classList.add('mic-active'); // Pulse animation
            
            recognition.lang = lang;
            recognition.start();
        }

        function resetMic() {
            document.getElementById('micKoBtn').classList.remove('mic-active');
            document.getElementById('micViBtn').classList.remove('mic-active');
        }
        
        // Settings Modal Logic
        document.getElementById('settingsBtn').addEventListener('click', () => {
            const k = localStorage.getItem('gemini_api_key');
            if(k) document.getElementById('apiKeyInput').value = k;
            document.getElementById('apiModal').classList.remove('hidden');
        });
        function closeModal() { document.getElementById('apiModal').classList.add('hidden'); }
        function saveApiKey() {
            const k = document.getElementById('apiKeyInput').value.trim();
            if(k) { localStorage.setItem('gemini_api_key', k); closeModal(); }
        }
    </script>
</body>
</html>
